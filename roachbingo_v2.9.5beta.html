<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Event Bingo Generator</title>
    <!-- 
    The Tailwind CDN is kept as the single external dependency for lightweight, modern styling.
    The core application logic remains self-contained and highly compatible.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* * COLORBLIND-FRIENDLY PALETTES
         * Dark Theme: Uses a high-contrast Yellow/Cyan pairing.
         * Sunset Theme: Uses a high-contrast Blue/Orange pairing.
        */
        :root {
            --bg-color: #111827;        /* Dark Blue-Grey 900 */
            --text-color: #f3f4f6;      /* Light Grey 100 */
            --primary-accent: #fcd34d;  /* Amber 300 (Borders / Winning) */
            --secondary-accent: #06b6d4;/* Vibrant Cyan 500 (Marked) */
        }
        .theme-sunset {
            --bg-color: #FFF7ED;        /* Light Cream */
            --text-color: #1c274b;      /* Dark Twilight Blue */
            --primary-accent: #ea580c;  /* Deep Orange 600 (Borders / Winning) */
            --secondary-accent: #2563eb;/* Vibrant Blue 600 (Marked) */
        }

        body {
            /* Using a highly readable, system-safe font stack (sans-serif) 
            to ensure 100% offline rendering and lightweight load. */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Style for the bold main title */
        .main-title {
            font-weight: 900; /* Extra bold title */
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        /* Confetti Canvas Overlay */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to go through to the bingo grid */
            z-index: 1000;
        }

        /* Container for the game */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            position: relative; 
            z-index: 10;
        }

        /* Bingo Grid Styling */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            aspect-ratio: 1 / 1; /* Ensures the grid is always square */
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }

        .bingo-cell {
            background-color: var(--bg-color);
            border: 2px solid var(--primary-accent);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.15s, transform 0.1s, border-color 0.3s;
            height: 100%; /* Fill the grid area */
        }

        .bingo-cell:hover {
            transform: scale(0.98);
            box-shadow: 0 0 15px var(--primary-accent);
        }

        .bingo-cell.marked {
            background-color: var(--secondary-accent);
            color: var(--text-color);
            border-color: var(--secondary-accent);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s, transform 0.1s;
        }
        
        .bingo-cell.winning {
            background-color: var(--primary-accent) !important;
            color: var(--bg-color); 
            animation: pulse-glow 1s infinite alternate;
        }
        
        /* Specific text color override for winning sunset cells to ensure contrast */
        .theme-sunset .bingo-cell.winning {
            color: #ffffff; 
        }


        @keyframes pulse-glow {
            from { box-shadow: 0 0 10px var(--primary-accent), 0 0 0px var(--primary-accent); }
            to { box-shadow: 0 0 20px var(--primary-accent), 0 0 10px var(--primary-accent); }
        }

        /* --- Custom Slide Toggle Styling --- */
        .switch {
            width: 56px; /* 14 tailwind scale */
            height: 32px; /* 8 tailwind scale */
        }
        
        .slider {
            /* Default Dark Theme Slider Track */
            background-color: #4b5563; 
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        /* When checked (Sunset theme) */
        .switch input:checked + .slider {
            background-color: var(--primary-accent); 
        }

        .switch input:checked + .slider:before {
            transform: translateX(24px); 
        }

        /* Adjust colors for the light theme panel */
        .theme-sunset .bg-gray-800 {
            background-color: #FFFFFF !important; 
            border-color: var(--primary-accent) !important; 
        }
        
        /* Ensure all text colors inside the light panel are dark */
        .theme-sunset .text-gray-400,
        .theme-sunset .text-gray-300,
        .theme-sunset .text-gray-200 {
            color: var(--text-color) !important;
        }

        /* Inputs and Selects should have a pale background and dark text */
        .theme-sunset textarea,
        .theme-sunset select,
        .theme-sunset input[type="text"] { 
            background-color: #FEE7C8 !important; 
            border-color: var(--primary-accent) !important; 
            color: var(--text-color) !important;
        }

        /* Inner boxes in the panel (used for grid size/theme) */
        .theme-sunset .bg-gray-900 {
            background-color: #FFFFFF !important; 
            border-color: #FEE7C8 !important;
        }
        
        /* Sunset Slider Overrides */
        .theme-sunset .slider {
            background-color: #9ca3af; 
        }
        .theme-sunset .slider:before {
            background-color: var(--text-color); 
        }
        .theme-sunset .switch input:checked + .slider:before {
            background-color: #FFFFFF; 
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .bingo-cell {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            .game-container {
                padding: 1rem;
            }
            .bingo-grid {
                gap: 4px;
            }
        }
        
    </style>
</head>
<body class="theme-dark">

    <canvas id="confettiCanvas"></canvas>

    <div class="game-container">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-black mb-2 tracking-tight main-title">Stream Event Bingo</h1>
            <p class="text-gray-400">The pro way to call BINGO during the next event or raid.</p>
        </header>

        <!-- Configuration Panel -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700 max-w-4xl mx-auto theme-panel">
            <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">1. Define Scenarios</h2>
            
            <!-- Bingo Title Input -->
            <label for="bingoTitleInput" class="block text-sm font-medium mb-1 text-gray-300">Bingo Sheet Title (e.g., Asmon's Raid Night)</label>
            <input type="text" id="bingoTitleInput" class="w-full p-3 mb-6 rounded-lg bg-gray-900 border border-gray-700 focus:ring-amber-500 focus:border-amber-500 text-gray-200" placeholder="e.g., Stream Event Bingo">
            
            <div class="md:flex md:space-x-4">
                <div class="flex-1 mb-4 md:mb-0">
                    <!-- DEDICATED FREE SPACE INPUT -->
                    <label for="freeSpaceInput" class="block text-sm font-medium mb-1 text-gray-300">Free Space Content (Center Cell for 3x3, 5x5 - Optional)</label>
                    <input type="text" id="freeSpaceInput" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 focus:ring-amber-500 focus:border-amber-500 text-gray-200" placeholder="e.g., Asmon Rages (This is always marked)">

                    <!-- MAIN SCENARIOS INPUT -->
                    <label for="scenariosInput" class="block text-sm font-medium mt-4 mb-1 text-gray-300">Enter Scenarios (One per line, Min. 24 for 5x5)</label>
                    <textarea id="scenariosInput" rows="8" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 focus:ring-amber-500 focus:border-amber-500 text-gray-200" placeholder="e.g.,&#10;Streamer makes a noise into the mic&#10;Says the word 'chat' or 'guys'&#10;Complains about RNG&#10;Disconnects / Technical issue"></textarea>
                </div>
                
                <!-- MODIFIED RIGHT COLUMN -->
                <div class="w-full md:w-64 space-y-3 md:mt-6">
                    
                    <!-- THEME BOX -->
                    <div class="p-3 bg-gray-900 rounded-lg border border-gray-700">
                        <label class="block text-sm font-medium mb-2 text-gray-300">Color Theme</label>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-400">Dark</span>
                            <label class="switch relative inline-block w-14 h-8">
                                <input type="checkbox" id="themeToggle" class="opacity-0 w-0 h-0">
                                <span class="slider round absolute cursor-pointer top-0 left-0 right-0 bottom-0 transition duration-400 rounded-full"></span>
                            </label>
                            <span class="text-sm font-medium text-gray-400">Sunset</span>
                        </div>
                    </div>
                    
                    <!-- GRID SIZE BOX -->
                    <div class="p-3 bg-gray-900 rounded-lg border border-gray-700">
                        <label class="block text-sm font-medium mb-2 text-gray-300">Grid Size</label>
                        <select id="gridSize" class="w-full p-2 rounded-md bg-gray-700 border-gray-600 text-gray-100 focus:ring-amber-500 focus:border-amber-500">
                            <option value="5">5x5 (25 cells)</option>
                            <option value="4">4x4 (16 cells)</option>
                            <option value="3">3x3 (9 cells)</option>
                        </select>
                    </div>
                </div>
                <!-- END MODIFIED RIGHT COLUMN -->
            </div>

            <div class="flex justify-center mt-6">
                <button id="generateBtn" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-extrabold py-3 px-8 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg shadow-amber-500/50">
                    GENERATE BINGO SHEET
                </button>
            </div>
        </div>

        <!-- Bingo Grid Display -->
        <div class="text-center mb-6">
            <h2 id="bingoTitle" class="text-3xl font-bold mb-4 tracking-wider uppercase text-amber-500 hidden"></h2>
        </div>
        
        <div id="bingoGridContainer" class="flex justify-center mb-8">
            <div id="bingoGrid" class="bingo-grid hidden">
                <!-- Bingo cells will be inserted here -->
            </div>
        </div>

        <!-- Action Buttons (Reset/New Game) -->
        <div id="gameControls" class="flex justify-center space-x-4 pt-4 hidden">
            <button id="resetBoardBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-md">
                <span class="text-lg">ðŸ”„</span> Clear Marks
            </button>
            <button id="newGameBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-md">
                <span class="text-lg">ðŸŽ²</span> New Sheet (Same Scenarios)
            </button>
        </div>
        
        <div id="messageBox" class="fixed bottom-0 right-0 m-4 p-4 rounded-xl shadow-2xl z-50 transition-transform duration-300 transform translate-x-full bg-green-600 text-white font-bold" style="min-width: 250px;">
            BINGO! You've got it!
        </div>

    </div>

    <!-- Main Application Logic (Self-Contained) -->
    <script>
        // --- Game State ---
        var gridSize = 5;
        var scenarios = []; // Not strictly used, but kept for clarity
        var board = []; // 2D array of scenario texts
        var marked = []; // 2D array of booleans
        var isGameOver = false;

        // --- DOM Elements ---
        var generateBtn = document.getElementById('generateBtn');
        var resetBoardBtn = document.getElementById('resetBoardBtn');
        var newGameBtn = document.getElementById('newGameBtn');
        var scenariosInput = document.getElementById('scenariosInput');
        var freeSpaceInput = document.getElementById('freeSpaceInput'); 
        var bingoTitleInput = document.getElementById('bingoTitleInput');
        var gridSizeSelect = document.getElementById('gridSize');
        var bingoGrid = document.getElementById('bingoGrid');
        var bingoTitle = document.getElementById('bingoTitle');
        var gameControls = document.getElementById('gameControls');
        var messageBox = document.getElementById('messageBox');
        var body = document.body;
        var themeToggle = document.getElementById('themeToggle');
        
        // --- Confetti Logic ---
        var confettiCanvas = document.getElementById('confettiCanvas');
        var ctx = confettiCanvas.getContext('2d');
        var confetti = [];
        var animationFrameId = null;

        // Configuration
        var MAX_CONFETTI = 150;
        var PARTICLE_SIZE = 8;
        // Use the theme colors plus a few extras
        var COLORS = [
            '#fcd34d', // Amber (Primary)
            '#06b6d4', // Cyan (Secondary)
            '#ef4444', // Red
            '#3b82f6', // Blue
            '#10b981', // Emerald
            '#8b5cf6', // Violet
        ];

        // Confetti Particle Constructor (Legacy Compatible)
        function Confetto(x, y, color) {
            this.x = x;
            this.y = y;
            // Randomize size slightly
            this.size = PARTICLE_SIZE * (0.5 + Math.random() * 0.5);
            this.color = color;
            this.rotation = Math.random() * Math.PI; // Initial rotation in radians
            this.rotationSpeed = (Math.random() * 0.1 - 0.05); // Spin speed
            // Random velocity, shooting up and slightly out
            this.vx = (Math.random() - 0.5) * 10; 
            this.vy = -(5 + Math.random() * 10); 
            this.gravity = 0.5;
        }

        Confetto.prototype.update = function() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += this.gravity;
            this.rotation += this.rotationSpeed;
        };

        Confetto.prototype.draw = function() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            ctx.fillStyle = this.color;
            // Draw a simple square
            ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
            ctx.restore();
        };

        /** Sets the canvas size to match the window dimensions. */
        function resizeConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }

        /** The main animation loop for the confetti. */
        function animateConfetti() {
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

            // Filter out particles that have fallen off the screen
            confetti = confetti.filter(function(c) { 
                return c.y < confettiCanvas.height + c.size; 
            });

            for (var i = 0; i < confetti.length; i++) {
                confetti[i].update();
                confetti[i].draw();
            }
            
            // Continue the loop if there are still particles
            if (confetti.length > 0) {
                animationFrameId = requestAnimationFrame(animateConfetti);
            } else {
                animationFrameId = null;
            }
        }

        /** Starts the confetti shower. */
        function startConfetti() {
            resizeConfetti();
            confetti = [];
            
            // Launch confetti from the center of the screen
            var centerX = confettiCanvas.width / 2;
            var centerY = confettiCanvas.height / 2;
            
            // Generate particles
            for (var i = 0; i < MAX_CONFETTI; i++) {
                var color = COLORS[Math.floor(Math.random() * COLORS.length)];
                // Spawn particles from the center of the screen
                confetti.push(new Confetto(centerX, centerY, color));
            }
            
            // Start the loop if not already running
            if (!animationFrameId) {
                animateConfetti();
            }

            // Stop confetti after 4 seconds
            setTimeout(stopConfetti, 4000);
        }
        
        /** Stops the confetti animation. */
        function stopConfetti() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            // Clear the canvas one last time
            ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        }
        
        window.addEventListener('resize', resizeConfetti);
        
        // --- Utility Functions ---

        /**
         * Shuffles an array in place (Fisher-Yates algorithm).
         * @param {Array} a The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffle(a) {
            var j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        /**
         * Displays a temporary notification message (BINGO!).
         * @param {string} msg The message to display.
         * @param {string} colorClass Tailwind class for background color.
         */
        function showMessage(msg, colorClass) {
            messageBox.textContent = msg;
            messageBox.className = 'fixed bottom-0 right-0 m-4 p-4 rounded-xl shadow-2xl z-50 transition-transform duration-300 transform translate-x-full font-bold';
            messageBox.classList.add(colorClass);
            
            // Show message
            requestAnimationFrame(function() {
                messageBox.classList.remove('translate-x-full');
            });

            // Hide message after 5 seconds
            setTimeout(function() {
                messageBox.classList.add('translate-x-full');
            }, 5000);
        }

        /**
         * Applies the selected theme colors to the body and updates the toggle state.
         * @param {string} themeName 'dark' or 'sunset'.
         */
        function setTheme(themeName) {
            body.classList.remove('theme-dark', 'theme-sunset');
            body.classList.add('theme-' + themeName);
            localStorage.setItem('bingoTheme', themeName);
            
            // Set the toggle checked state (true for sunset, false for dark)
            themeToggle.checked = (themeName === 'sunset');
            
            // Update panel theme classes for immediate visual consistency
            var panel = document.querySelector('.theme-panel');
            if (panel) {
                if (themeName === 'sunset') {
                    panel.classList.add('bg-white', 'border-orange-600');
                    panel.classList.remove('bg-gray-800', 'border-gray-700');
                } else {
                    panel.classList.remove('bg-white', 'border-orange-600');
                    panel.classList.add('bg-gray-800', 'border-gray-700');
                }
            }
        }
        
        // --- Game Logic ---
        
        /**
         * Renders the bingo grid based on the 'board' state.
         */
        function renderGrid() {
            bingoGrid.innerHTML = '';
            bingoGrid.style.gridTemplateColumns = 'repeat(' + gridSize + ', 1fr)';

            for (var r = 0; r < gridSize; r++) {
                for (var c = 0; c < gridSize; c++) {
                    var cell = document.createElement('div');
                    cell.className = 'bingo-cell group';
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    // Center cell is always Free Space for odd grid sizes
                    var isCenter = (gridSize % 2 !== 0) && r === Math.floor(gridSize / 2) && c === Math.floor(gridSize / 2);
                    
                    var content = board[r][c];
                    
                    if (isCenter) {
                        // The free space scenario is just the content of the dedicated input
                        cell.innerHTML = '<span class="text-xl font-black italic">' + content + '</span>';
                        cell.classList.add('marked'); // Center is marked by default
                        marked[r][c] = true;
                    } else {
                         // Truncate long text for better display in cells
                        var maxLen = gridSize === 5 ? 50 : 70;
                        var truncatedContent = content.length > maxLen ? content.substring(0, maxLen - 3) + '...' : content;
                        cell.textContent = truncatedContent;
                    }

                    if (marked[r][c]) {
                        cell.classList.add('marked');
                    }
                    
                    // Use a closure to capture r, c, and cell correctly
                    (function(r_val, c_val, cell_el) {
                        cell_el.addEventListener('click', function() {
                            toggleCell(r_val, c_val, cell_el);
                        });
                    })(r, c, cell);
                    
                    bingoGrid.appendChild(cell);
                }
            }
            bingoGrid.classList.remove('hidden');
            bingoTitle.classList.remove('hidden');
            gameControls.classList.remove('hidden');
        }
        
        /**
         * Toggles the marked state of a cell and checks for BINGO.
         */
        function toggleCell(r, c, cell) {
            if (isGameOver) return;
            
            var isCenter = (gridSize % 2 !== 0) && r === Math.floor(gridSize / 2) && c === Math.floor(gridSize / 2);
            if (isCenter) {
                // Free Space cannot be manually unmarked (it's always true)
                if (marked[r][c]) return; 
            }

            marked[r][c] = !marked[r][c];
            cell.classList.toggle('marked', marked[r][c]);

            checkBingo();
        }

        /**
         * Checks the current board state for any winning BINGO lines.
         */
        function checkBingo() {
            // Remove previous winning classes
            document.querySelectorAll('.bingo-cell').forEach(function(c) { 
                c.classList.remove('winning');
            });
            
            var win = false;
            var winningCells = [];

            // 1. Check Rows
            for (var r = 0; r < gridSize; r++) {
                var rowWin = true;
                for (var c = 0; c < gridSize; c++) {
                    if (!marked[r][c]) {
                        rowWin = false;
                        break;
                    }
                }
                if (rowWin) {
                    win = true;
                    for (var c_w = 0; c_w < gridSize; c_w++) winningCells.push([r, c_w]);
                }
            }

            // 2. Check Columns
            for (var c_check = 0; c_check < gridSize; c_check++) {
                var columnWin = true;
                var currentColumnCells = [];
                for (var r_check = 0; r_check < gridSize; r_check++) {
                    currentColumnCells.push([r_check, c_check]);
                    if (!marked[r_check][c_check]) {
                        columnWin = false;
                        break;
                    }
                }
                if (columnWin) {
                    win = true;
                    winningCells = winningCells.concat(currentColumnCells);
                }
            }

            // 3. Check Diagonals (only for square grids)
            // Diagonal 1: Top-Left to Bottom-Right
            var diag1Win = true;
            var diag1Cells = [];
            for (var i = 0; i < gridSize; i++) {
                diag1Cells.push([i, i]);
                if (!marked[i][i]) {
                    diag1Win = false;
                    break;
                }
            }
            if (diag1Win) {
                win = true;
                winningCells = winningCells.concat(diag1Cells);
            }

            // Diagonal 2: Top-Right to Bottom-Left
            var diag2Win = true;
            var diag2Cells = [];
            for (var j = 0; j < gridSize; j++) {
                diag2Cells.push([j, gridSize - 1 - j]);
                if (!marked[j][gridSize - 1 - j]) {
                    diag2Win = false;
                    break;
                }
            }
            if (diag2Win) {
                win = true;
                winningCells = winningCells.concat(diag2Cells);
            }

            if (win) {
                // Mark winning cells and declare BINGO
                isGameOver = true;
                
                // Start the confetti effect!
                startConfetti(); 
                
                // Use a temporary object/map to ensure unique cells are processed without using ES6 Set
                var uniqueWinningCells = {};
                for (var k = 0; k < winningCells.length; k++) {
                    var cellKey = winningCells[k].join(',');
                    uniqueWinningCells[cellKey] = true;
                }
                
                var cellKeys = Object.keys(uniqueWinningCells);

                for (var l = 0; l < cellKeys.length; l++) {
                    var parts = cellKeys[l].split(',');
                    var r_win = parseInt(parts[0]);
                    var c_win = parseInt(parts[1]);
                    
                    var cell = document.querySelector('.bingo-cell[data-row="' + r_win + '"][data-col="' + c_win + '"]');
                    if (cell) {
                        cell.classList.add('winning');
                    }
                }

                showMessage("BINGO! The prophecy has been fulfilled!", 'bg-green-600');
                bingoTitle.textContent = "BINGO! GAME OVER.";
            }
        }
        
        /**
         * Main function to generate and display the new bingo sheet.
         */
        function generateBingoSheet() {
            isGameOver = false;
            stopConfetti(); // Ensure confetti stops if a new game is started
            
            var customTitle = bingoTitleInput.value.trim();
            bingoTitle.textContent = customTitle.toUpperCase() || "NEW EVENT BINGO";
            
            // Read main scenarios (excluding any free space)
            var rawScenarios = scenariosInput.value.split('\n').map(function(s) { 
                return s.trim(); 
            }).filter(function(s) { 
                return s.length > 0; 
            });
            
            // Read dedicated free space content
            var freeSpaceScenario = freeSpaceInput.value.trim();
            
            gridSize = parseInt(gridSizeSelect.value);
            var totalCells = gridSize * gridSize;
            
            // Determine if a free space cell is applicable and available
            var neededScenarios = totalCells;
            // Only for odd grids AND if content is provided
            var hasFreeSpace = (gridSize % 2 !== 0 && freeSpaceScenario.length > 0); 
            var freeSpaceIndex = hasFreeSpace ? Math.floor(gridSize / 2) * gridSize + Math.floor(gridSize / 2) : -1;
            
            if (hasFreeSpace) {
                neededScenarios -= 1; // Need one less scenario for the non-free-space cells
            }

            if (rawScenarios.length < neededScenarios) {
                showMessage('ERROR: Need ' + neededScenarios + ' unique scenarios for a ' + gridSize + 'x' + gridSize + ' grid. You provided ' + rawScenarios.length + '.', 'bg-red-600');
                return;
            }

            // 1. Shuffle and Select Scenarios
            var shuffledScenarios = shuffle(rawScenarios.slice(0)).slice(0, neededScenarios); // Create shallow copy for shuffle
            
            // 2. Build the 2D Board Array
            board = Array(gridSize).fill(null).map(function() { 
                return Array(gridSize).fill(null); 
            });
            marked = Array(gridSize).fill(null).map(function() { 
                return Array(gridSize).fill(false); 
            });
            
            var scenarioIndex = 0;
            for (var r = 0; r < gridSize; r++) {
                for (var c = 0; c < gridSize; c++) {
                    var currentIndex = r * gridSize + c;
                    
                    if (hasFreeSpace && currentIndex === freeSpaceIndex) {
                        board[r][c] = freeSpaceScenario;
                        marked[r][c] = true; // Mark free space by default
                    } else {
                        board[r][c] = shuffledScenarios[scenarioIndex];
                        scenarioIndex++;
                    }
                }
            }
            
            renderGrid();
        }

        /**
         * Resets the 'marked' state of the board.
         */
        function resetBoardMarks() {
            if (board.length === 0) return;
            isGameOver = false;
            stopConfetti(); // Ensure confetti stops
            
            var customTitle = bingoTitleInput.value.trim();
            bingoTitle.textContent = customTitle.toUpperCase() || "NEW EVENT BINGO";
            
            marked = Array(gridSize).fill(null).map(function() { 
                return Array(gridSize).fill(false); 
            });

            // Re-mark the free space if present
            var isCenter = (gridSize % 2 !== 0);
            if (isCenter) {
                var r = Math.floor(gridSize / 2);
                var c = Math.floor(gridSize / 2);
                
                // Check if the center cell content is the free space content
                if (board[r][c] === freeSpaceInput.value.trim()) {
                    marked[r][c] = true;
                }
            }
            
            renderGrid();
        }


        // --- Event Listeners and Initialization ---

        generateBtn.addEventListener('click', generateBingoSheet);
        newGameBtn.addEventListener('click', generateBingoSheet); // Same logic: shuffle and regenerate
        resetBoardBtn.addEventListener('click', resetBoardMarks);
        
        // Listen for changes on the slide toggle
        themeToggle.addEventListener('change', function() {
            var newTheme = themeToggle.checked ? 'sunset' : 'dark';
            setTheme(newTheme);
        });
        
        // Utility for Array.prototype.every for compatibility
        if (!Array.prototype.every) {
            Array.prototype.every = function(callback, thisArg) {
                var T, k;
                if (this == null) {
                    throw new TypeError('this is null or not defined');
                }
                var O = Object(this);
                var len = O.length >>> 0;
                if (typeof callback !== 'function') {
                    throw new TypeError();
                }
                if (arguments.length > 1) {
                    T = thisArg;
                }
                k = 0;
                while (k < len) {
                    var kValue;
                    if (k in O) {
                        kValue = O[k];
                        if (!callback.call(T, kValue, k, O)) {
                            return false;
                        }
                    }
                    k++;
                }
                return true;
            };
        }
        
        function init() {
            // Load theme from localStorage or default to 'dark'
            var savedTheme = localStorage.getItem('bingoTheme') || 'dark';
            setTheme(savedTheme); // This also sets the initial toggle state
            
            // Populate sample data for first run experience
            if (bingoTitleInput.value.trim() === '') {
                bingoTitleInput.value = "Stream Event Bingo";
                freeSpaceInput.value = 'Asmon Rages'; // Set initial value as requested

                scenariosInput.value = 'Streamer makes a noise into the mic\nTalks about the state of the game\nComplains about the developers\nGets a rare drop\nSays "I\'m telling you guys"\nPuts on the headset backwards\nMentions Final Fantasy XIV\nComplains about the Twitch meta\nChecks Twitter/Reddit drama\nMentions the Golden One\nTechnical difficulty / D/C\nRage quits (for less than 5 min)\nTakes a long sip of water\nShouts at a viewer\nMentions their hair/baldness\nStarts a new game/alt\nUnnecessarily loud keyboard clicks\nA pet interrupts the stream\nSays "It is what it is"\nMentions the oil\nSomeone gifts subs\nPuts a piece of food in their mouth\nSays a bad word\nMisclicks badly';
            }
            
            // Generate the initial sheet with default/pre-loaded data
            generateBingoSheet();
        }
        
        // Use a standard DOMContentLoaded fallback for reliable initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Final window.onload call for absolute safety (mostly for resource loading)
        window.onload = function() {
             resizeConfetti(); // Ensure initial confetti canvas size is set
        };
        
    </script>
</body>
</html>
